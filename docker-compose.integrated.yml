name: hris-integrated

services:
  # ========== REAL TALENTA API CLIENT (menggantikan mock-talenta) ==========
  talenta-api:
    build:
      context: ../consume-endpoint
      dockerfile: Dockerfile
    container_name: hris-talenta-api
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - MEKARI_API_BASE_URL=${MEKARI_API_BASE_URL:-https://api.mekari.com}
      - MEKARI_API_CLIENT_ID=${MEKARI_API_CLIENT_ID}
      - MEKARI_API_CLIENT_SECRET=${MEKARI_API_CLIENT_SECRET}
    networks:
      - hris-integrated-net
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ========== MIDDLEWARE ==========
  middleware:
    build:
      context: ./services/middleware
      dockerfile: Dockerfile
    container_name: hris-middleware
    ports:
      - "3002:3002"
    environment:
      - ENVIRONMENT=production
      - NODE_ENV=production
      - PORT=3002

      # Talenta API - UPDATED to use real API client
      - TALENTA_API_URL=http://talenta-api:3000
      - TALENTA_ACCESS_TOKEN=${TALENTA_ACCESS_TOKEN:-}
      - TALENTA_COMPANY_ID=${TALENTA_COMPANY_ID:-1}

      # Database
      - DB_HOST=postgres-middleware
      - DB_PORT=5432
      - DB_NAME=hris_metadata
      - DB_USER=hris
      - DB_PASSWORD=${DB_PASSWORD:-hrispass}

      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379

      # SFTP
      - SFTP_HOST=sftp-server
      - SFTP_PORT=22
      - SFTP_USER=hris
      - SFTP_PASSWORD=${SFTP_PASSWORD:-hrispass}
      - SFTP_INBOUND_PATH=/data/inbound
      - SFTP_ARCHIVE_PATH=/data/archive

      # Encryption
      - PGP_PUBLIC_KEY_PATH=/keys/oic_public.asc
      - PGP_PRIVATE_KEY_PATH=/keys/oic_private.asc

      # Storage
      - TEMP_DIR=/tmp/hris
      - OUTPUT_DIR=/data/output
      - ARCHIVE_DIR=/data/archive

      # Processing
      - BUSINESS_UNIT=MY
      - BATCH_SIZE=50

      # Features - UPDATED to use real Talenta API
      - USE_MOCK_TALENTA=false
      - USE_MOCK_OIC=${USE_MOCK_OIC:-true}
      - SKIP_ENCRYPTION=true
      - SKIP_UPLOAD=false
    volumes:
      - ./config/keys:/keys:ro
      - sftp-data:/data
    depends_on:
      postgres-middleware:
        condition: service_healthy
      talenta-api:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - hris-integrated-net

  # ========== MOCK OIC (Optional - bisa diganti dengan real OIC) ==========
  mock-oic:
    build:
      context: ./services/mock-oic
      dockerfile: Dockerfile
    container_name: hris-mock-oic
    environment:
      - WATCH_DIR=/data/inbound
      - ARCHIVE_DIR=/data/archive
      - TEMP_DIR=/tmp/oic
      - PGP_PRIVATE_KEY_PATH=/keys/oic_private.asc

      # Mock HCM Database
      - DB_HOST=postgres-hcm
      - DB_PORT=5432
      - DB_NAME=mock_hcm
      - DB_USER=hcm
      - DB_PASSWORD=${HCM_DB_PASSWORD:-hcmpass}
    volumes:
      - ./config/keys:/keys:ro
      - sftp-data:/data
    depends_on:
      postgres-hcm:
        condition: service_healthy
    networks:
      - hris-integrated-net

  # ========== DATABASES ==========
  postgres-middleware:
    image: postgres:16-alpine
    container_name: hris-postgres-middleware
    environment:
      POSTGRES_USER: hris
      POSTGRES_PASSWORD: ${DB_PASSWORD:-hrispass}
      POSTGRES_DB: hris_metadata
    volumes:
      - ./database/middleware-schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - postgres-middleware-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - hris-integrated-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hris -d hris_metadata"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-hcm:
    image: postgres:16-alpine
    container_name: hris-postgres-hcm
    environment:
      POSTGRES_USER: hcm
      POSTGRES_PASSWORD: ${HCM_DB_PASSWORD:-hcmpass}
      POSTGRES_DB: mock_hcm
    volumes:
      - ./database/mock-hcm-schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - postgres-hcm-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - hris-integrated-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hcm -d mock_hcm"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========== REDIS ==========
  redis:
    image: redis:7-alpine
    container_name: hris-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - hris-integrated-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ========== SFTP SERVER ==========
  sftp-server:
    image: atmoz/sftp:alpine
    platform: linux/amd64
    container_name: hris-sftp
    command: hris:hrispass:1000:1000:data
    ports:
      - "2222:22"
    volumes:
      - sftp-data:/home/hris/data
    networks:
      - hris-integrated-net

  # ========== VAULT ==========
  vault:
    image: hashicorp/vault:1.15
    container_name: hris-vault
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_TOKEN:-devtoken}
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    ports:
      - "8200:8200"
    cap_add:
      - IPC_LOCK
    volumes:
      - vault-data:/vault/data
    networks:
      - hris-integrated-net

  # ========== UTILITIES ==========
  adminer:
    image: adminer:4
    platform: linux/amd64
    container_name: hris-adminer
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres-middleware
    networks:
      - hris-integrated-net

networks:
  hris-integrated-net:
    driver: bridge
    name: hris-integrated-network

volumes:
  postgres-middleware-data:
    name: hris-postgres-middleware-data
  postgres-hcm-data:
    name: hris-postgres-hcm-data
  redis-data:
    name: hris-redis-data
  sftp-data:
    name: hris-sftp-data
  vault-data:
    name: hris-vault-data
